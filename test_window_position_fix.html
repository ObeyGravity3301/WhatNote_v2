<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>窗口位置保存测试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f0f0f0; 
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .test-step {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #007acc;
            background-color: #f8f9fa;
        }
        .success { border-left-color: #28a745; }
        .warning { border-left-color: #ffc107; }
        .error { border-left-color: #dc3545; }
        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #005a9e; }
        .status { font-weight: bold; }
        .instructions {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔧 窗口位置保存修复测试</h1>
        
        <div class="instructions">
            <h3>📋 测试说明</h3>
            <p>此测试页面帮助您验证窗口位置保存功能是否正常工作。</p>
            <ol>
                <li>确保 WhatNote V2 应用正在运行 (http://localhost:3000)</li>
                <li>按照下面的步骤进行测试</li>
                <li>观察控制台日志，查看是否有循环重新加载的问题</li>
            </ol>
        </div>

        <div class="test-step">
            <h3>步骤 1: 打开应用</h3>
            <p>在新标签页中打开 WhatNote V2 应用</p>
            <button onclick="openApp()">打开 WhatNote V2</button>
            <div id="step1-status" class="status"></div>
        </div>

        <div class="test-step">
            <h3>步骤 2: 创建测试窗口</h3>
            <p>在应用中右键桌面，选择"新建项目"创建一个文本窗口</p>
            <div id="step2-status" class="status">⏳ 请在应用中创建新窗口</div>
        </div>

        <div class="test-step">
            <h3>步骤 3: 移动窗口</h3>
            <p>拖拽窗口到不同位置，观察控制台是否出现保存日志</p>
            <div id="step3-status" class="status">⏳ 请移动窗口并观察控制台</div>
        </div>

        <div class="test-step">
            <h3>步骤 4: 调整窗口大小</h3>
            <p>拖拽窗口右下角调整大小，观察控制台是否出现保存日志</p>
            <div id="step4-status" class="status">⏳ 请调整窗口大小并观察控制台</div>
        </div>

        <div class="test-step">
            <h3>步骤 5: 刷新页面测试</h3>
            <p>刷新应用页面，检查窗口是否保持在新的位置和大小</p>
            <button onclick="refreshApp()">刷新应用页面</button>
            <div id="step5-status" class="status">⏳ 请刷新页面检查窗口状态</div>
        </div>

        <div class="test-step">
            <h3>步骤 6: 观察控制台</h3>
            <p>检查浏览器控制台，确认没有循环的文件监控事件</p>
            <div>
                <p><strong>期望看到的日志：</strong></p>
                <ul>
                    <li>💾 保存窗口状态: [窗口ID] 更新字段: ['position', 'size', 'hidden']</li>
                    <li>✅ 窗口状态保存成功: [窗口ID]</li>
                    <li>🚫 正在保存窗口状态，忽略文件监控事件 (这是好的！)</li>
                </ul>
                <p><strong>不应该看到的日志：</strong></p>
                <ul>
                    <li>频繁的 "🔄 文件监控触发：重新加载展板数据"</li>
                    <li>连续不断的文件监控事件</li>
                </ul>
            </div>
            <div id="step6-status" class="status">⏳ 请检查控制台日志</div>
        </div>

        <div class="test-step success" style="display: none;" id="success-message">
            <h3>🎉 测试成功！</h3>
            <p>窗口位置保存功能正常工作，没有循环重新加载问题。</p>
        </div>

        <div class="test-step error" style="display: none;" id="error-message">
            <h3>❌ 测试失败</h3>
            <p>仍然存在问题，请检查控制台错误信息。</p>
        </div>

        <div style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 5px;">
            <h3>🔍 故障排除</h3>
            <p>如果测试失败，请检查：</p>
            <ul>
                <li>确保服务器正在运行 (后端端口 8081，前端端口 3000)</li>
                <li>检查浏览器控制台是否有错误信息</li>
                <li>确认网络连接正常</li>
                <li>检查后端日志是否有异常</li>
            </ul>
        </div>
    </div>

    <script>
        function openApp() {
            window.open('http://localhost:3000', '_blank');
            document.getElementById('step1-status').innerHTML = '✅ 应用已在新标签页中打开';
            document.getElementById('step1-status').className = 'status success';
        }

        function refreshApp() {
            // 尝试向应用窗口发送刷新消息
            const appWindow = window.open('http://localhost:3000', 'whatnote_app');
            if (appWindow) {
                appWindow.location.reload();
                document.getElementById('step5-status').innerHTML = '✅ 应用页面已刷新';
                document.getElementById('step5-status').className = 'status success';
            } else {
                document.getElementById('step5-status').innerHTML = '⚠️ 请手动刷新应用页面';
                document.getElementById('step5-status').className = 'status warning';
            }
        }

        // 简单的状态跟踪
        let testResults = {
            step1: false,
            step2: false,
            step3: false,
            step4: false,
            step5: false,
            step6: false
        };

        function updateTestStatus() {
            const allPassed = Object.values(testResults).every(result => result);
            if (allPassed) {
                document.getElementById('success-message').style.display = 'block';
                document.getElementById('error-message').style.display = 'none';
            }
        }

        // 添加一些辅助提示
        setTimeout(() => {
            console.log('🧪 窗口位置保存测试页面已加载');
            console.log('📝 请按照页面上的步骤进行测试');
            console.log('🔍 重点观察控制台中的保存日志和文件监控事件');
        }, 1000);
    </script>
</body>
</html>
